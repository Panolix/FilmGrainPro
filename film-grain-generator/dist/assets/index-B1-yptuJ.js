(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();async function o(s,t={},e){return window.__TAURI_INTERNALS__.invoke(s,t,e)}class m{constructor(){this.canvas=document.getElementById("grainCanvas"),this.ctx=this.canvas.getContext("2d"),this.currentImageData=null,this.updateTimeout=null,this.initializeControls()}async loadFilmStocks(){try{const t=await o("get_available_film_stocks"),e=document.getElementById("filmStock");e.innerHTML="",t.forEach(i=>{const n=document.createElement("option");n.value=i,n.textContent=i,e.appendChild(n)}),this.updateFilmInfo(),this.generateInitialGrain()}catch(t){console.error("Failed to load film stocks:",t),this.generateInitialGrain()}}async updateFilmInfo(){const t=document.getElementById("filmStock").value;if(t)try{const e=await o("get_film_info",{filmName:t});document.getElementById("filmInfoTitle").textContent=t,document.getElementById("filmInfoDescription").textContent=e.description,document.getElementById("filmInfoUses").textContent=e.primary_uses.join(", "),document.getElementById("filmInfoCharacteristics").textContent=e.characteristics.join(", "),document.getElementById("filmInfoUsers").textContent=e.famous_users.join(", "),document.getElementById("filmInfoEra").textContent=e.era,document.getElementById("filmInfoPrice").textContent=e.price_category,document.getElementById("filmInfoDetails").style.display="block"}catch(e){console.error("Failed to load film info:",e),document.getElementById("filmInfoTitle").textContent=t,document.getElementById("filmInfoDescription").textContent="Film information not available.",document.getElementById("filmInfoDetails").style.display="none"}}async initializeControls(){await this.loadFilmStocks(),document.getElementById("filmStock").addEventListener("change",()=>{this.updateFilmInfo(),this.regenerateGrain()});const e=["grainIntensity","grainSize","contrast","canvasWidth","canvasHeight"];document.getElementById("maxGrainCount").addEventListener("change",()=>this.regenerateGrain()),e.forEach(n=>{const a=document.getElementById(n),r=document.getElementById(n+"Value");a.addEventListener("input",l=>{let c=l.target.value;n==="grainIntensity"||n==="contrast"?c+="%":n==="grainSize"&&(c+="x"),r.textContent=c,(n==="canvasWidth"||n==="canvasHeight")&&this.updateCanvasSize()}),a.addEventListener("change",()=>this.regenerateGrain()),n!=="canvasWidth"&&n!=="canvasHeight"&&a.addEventListener("input",()=>{clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>this.regenerateGrain(),300)})}),document.getElementById("regenerateBtn").addEventListener("click",()=>{this.regenerateGrain()}),document.getElementById("saveBtn").addEventListener("click",()=>{this.saveImage()})}updateCanvasSize(){const t=parseInt(document.getElementById("canvasWidth").value),e=parseInt(document.getElementById("canvasHeight").value);this.canvas.width=t,this.canvas.height=e,this.regenerateGrain()}async generateInitialGrain(){await this.regenerateGrain()}async regenerateGrain(){const t=this.getGrainParameters();try{const e=document.getElementById("regenerateBtn"),i=e.textContent;e.textContent="Generating...",e.disabled=!0;const n=await o("generate_grain",{params:t});this.displayGrainResult(n),this.updatePerformanceInfo(n),e.textContent=i,e.disabled=!1}catch(e){console.error("Error generating grain:",e),alert("Error generating grain: "+e)}}getGrainParameters(){var t;return{film_stock:document.getElementById("filmStock").value,intensity:parseFloat(document.getElementById("grainIntensity").value),size_multiplier:parseFloat(document.getElementById("grainSize").value),contrast:parseFloat(document.getElementById("contrast").value),width:parseInt(document.getElementById("canvasWidth").value),height:parseInt(document.getElementById("canvasHeight").value),background:"transparent",max_grain_count:parseInt(((t=document.getElementById("maxGrainCount"))==null?void 0:t.value)||2e4)}}displayGrainResult(t){const{data:e,width:i,height:n}=t,a=new ImageData(new Uint8ClampedArray(e),i,n);this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.putImageData(a,0,0),this.currentImageData=e}updatePerformanceInfo(t){const e=document.getElementById("performanceInfo");e.textContent=`Generation time: ${t.generation_time_ms}ms | Grains: ${t.grain_count.toLocaleString()}`}async saveImage(){if(!this.currentImageData){alert("No grain image to save");return}try{const t=this.getGrainParameters(),e=new Date().toISOString().replace(/[:.]/g,"-"),i=`grain_${t.film_stock.replace(/\s+/g,"_")}_${e}.png`;await o("save_grain_image",{data:this.currentImageData,width:t.width,height:t.height,path:i}),alert(`Grain image saved as ${i}!`)}catch(t){console.error("Error saving image:",t),alert("Error saving image: "+t)}}}document.addEventListener("DOMContentLoaded",()=>{new m});
