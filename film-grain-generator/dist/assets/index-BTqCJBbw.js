(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(e){if(e.ep)return;e.ep=!0;const r=n(e);fetch(e.href,r)}})();async function c(s,t={},n){return window.__TAURI_INTERNALS__.invoke(s,t,n)}class l{constructor(){this.canvas=document.getElementById("grainCanvas"),this.ctx=this.canvas.getContext("2d"),this.currentImageData=null,this.updateTimeout=null,this.initializeControls()}async loadFilmStocks(){try{const t=await c("get_available_film_stocks"),n=document.getElementById("filmStock");n.innerHTML="",t.forEach(a=>{const e=document.createElement("option");e.value=a,e.textContent=a,n.appendChild(e)}),this.generateInitialGrain()}catch(t){console.error("Failed to load film stocks:",t),this.generateInitialGrain()}}async initializeControls(){await this.loadFilmStocks(),document.getElementById("filmStock").addEventListener("change",()=>this.regenerateGrain()),["grainIntensity","grainSize","contrast","canvasWidth","canvasHeight"].forEach(a=>{const e=document.getElementById(a),r=document.getElementById(a+"Value");e.addEventListener("input",i=>{let o=i.target.value;a==="grainIntensity"||a==="contrast"?o+="%":a==="grainSize"&&(o+="x"),r.textContent=o,(a==="canvasWidth"||a==="canvasHeight")&&this.updateCanvasSize()}),e.addEventListener("change",()=>this.regenerateGrain()),a!=="canvasWidth"&&a!=="canvasHeight"&&e.addEventListener("input",()=>{clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>this.regenerateGrain(),300)})}),document.getElementById("regenerateBtn").addEventListener("click",()=>{this.regenerateGrain()}),document.getElementById("saveBtn").addEventListener("click",()=>{this.saveImage()})}updateCanvasSize(){const t=parseInt(document.getElementById("canvasWidth").value),n=parseInt(document.getElementById("canvasHeight").value);this.canvas.width=t,this.canvas.height=n,this.regenerateGrain()}async generateInitialGrain(){await this.regenerateGrain()}async regenerateGrain(){const t=this.getGrainParameters();try{const n=document.getElementById("regenerateBtn"),a=n.textContent;n.textContent="Generating...",n.disabled=!0;const e=await c("generate_grain",{params:t});this.displayGrainResult(e),this.updatePerformanceInfo(e),n.textContent=a,n.disabled=!1}catch(n){console.error("Error generating grain:",n),alert("Error generating grain: "+n)}}getGrainParameters(){return{film_stock:document.getElementById("filmStock").value,intensity:parseFloat(document.getElementById("grainIntensity").value),size_multiplier:parseFloat(document.getElementById("grainSize").value),contrast:parseFloat(document.getElementById("contrast").value),width:parseInt(document.getElementById("canvasWidth").value),height:parseInt(document.getElementById("canvasHeight").value),background:"transparent"}}displayGrainResult(t){const{data:n,width:a,height:e}=t,r=new ImageData(new Uint8ClampedArray(n),a,e);this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.putImageData(r,0,0),this.currentImageData=n}updatePerformanceInfo(t){const n=document.getElementById("performanceInfo");n.textContent=`Generation time: ${t.generation_time_ms}ms | Grains: ${t.grain_count.toLocaleString()}`}async saveImage(){if(!this.currentImageData){alert("No grain image to save");return}try{const t=this.getGrainParameters(),n=new Date().toISOString().replace(/[:.]/g,"-"),a=`grain_${t.film_stock.replace(/\s+/g,"_")}_${n}.png`;await c("save_grain_image",{data:this.currentImageData,width:t.width,height:t.height,path:a}),alert(`Grain image saved as ${a}!`)}catch(t){console.error("Error saving image:",t),alert("Error saving image: "+t)}}}document.addEventListener("DOMContentLoaded",()=>{new l});
